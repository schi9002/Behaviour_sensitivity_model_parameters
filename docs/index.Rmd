---
title: "7 Sensitivity analysis - Scenario Comparison"
author: "Simon Chiu"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    highlight: kate
  html_document:
    df_print: paged
  pdf_document: default
  editor_options:
chunk_output_type: inline
      
---

```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
gc()

library(progress)
library(tidyverse)
library(openxlsx)
library(ggplot2)
library(patchwork)
library(ggh4x)
library(ggpubr)
library(ggbrace)

# devtools::install_github("nicolash2/ggbrace")

focus_df<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/focus_df_2023-07-18.RDS")
sensitivity_ran_variables<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/sensitivity_ran_variables_2023-07-17.RDS")
det_bmi_df<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/det_bmi_df_2023-07-16.RDS") %>%
  rename("bmi.output"="bmi", "age.groups.output"="age.groups", "gender.output"="gender")
det_bmi_df<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/det_bmi_df_2023-07-16.RDS") %>%
  rename("bmi.output"="bmi", "age.groups.output"="age.groups", "gender.output"="gender")
load("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/lsa_seq_sample_2023-07-16.RData")
lsa_bmi_df<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/lsa_bmi_df_2023-07-18.RDS")

lsa.sensivity.seq.sample<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/lsa_sensivity_seq_sample_2023-07-17.RDS")


focus_df_epoch<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/focus_df_epoch_2023-07-16.RDS")
focus_df_cci<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/focus_df_cci_2023-07-16.RDS")
focus_df_si<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/focus_df_si_2023-07-16.RDS")
focus_df_svi<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/focus_df_svi_2023-07-16.RDS")
focus_df_ssb<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/focus_df_ssb_2023-07-16.RDS")

lsa_int_epoch_df<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/lsa_int_epoch_df_2023-07-30.RDS")
lsa_int_cci_df<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/lsa_int_cci_df_2023-07-30.RDS")
lsa_int_si_df<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/lsa_int_si_df_2023-07-30.RDS")
lsa_int_svi_df<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/lsa_int_svi_df_2023-08-01.RDS")
lsa_int_ssb_df<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/lsa_int_ssb_df_2023-07-30.RDS")

derivative_lsa_epoch_int<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/derivative_lsa_epoch_int_2023-07-31.RDS")
derivative_lsa_cci_int<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/derivative_lsa_cci_int_2023-07-31.RDS")
derivative_lsa_si_int<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/derivative_lsa_si_int_2023-07-31.RDS")
derivative_lsa_svi_int<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/derivative_lsa_svi_int_2023-08-01.RDS")
derivative_lsa_ssb_int<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/derivative_lsa_ssb_int_2023-07-31.RDS")

det_bmi_df_wide<-det_bmi_df %>% 
  filter(scenario!="Base model") %>% 
  rename('det.int.value'='2057') %>% 
  select("scenario" ,"run","bmi.output","age.groups.output","gender.output", "det.int.value") %>% 
  left_join(., det_bmi_df %>% 
              filter(scenario=="Base model") %>% 
              rename('det.base.model.value'='2057') %>% 
              select("bmi.output","age.groups.output","gender.output", "det.base.model.value"),
            by=c("bmi.output","age.groups.output","gender.output"))

lsa_int_epoch_df<-lsa_int_epoch_df %>% 
  mutate(scenario=factor(case_when(scenario == "1 EPOCH"~1,
                                 scenario == "2 CCI"~2,
                                 scenario == "3 SI"~3,
                                 scenario == "4 SVI"~4,
                                 scenario == "5 SSB"~5,
                                 scenario == "6 EPOCH CCI"~6,
                                 scenario == "7 SI SVI"~7,
                                 scenario == "8 EPOCH CCI SI SVI"~8,
                                 scenario == "9 EPOCH CCI SI SVI SSB"~9),
                       levels=c(1:9),
                       labels = c("EPOCH", "CCI", "SI", "SVI", "SSB", "EPOCH+CCI",
                                  "SI+SVI",  "EPOCH+CCI+SI+SVI", "EPOCH+CCI+SI+SVI+SSB"))) %>% 
left_join(., det_bmi_df_wide %>% select(-run),
          by=c("scenario","bmi.output","age.groups.output","gender.output"))

lsa_int_cci_df<-lsa_int_cci_df %>%
  mutate(scenario=factor(case_when(scenario == "1 EPOCH"~1,
                                 scenario == "2 CCI"~2,
                                 scenario == "3 SI"~3,
                                 scenario == "4 SVI"~4,
                                 scenario == "5 SSB"~5,
                                 scenario == "6 EPOCH CCI"~6,
                                 scenario == "7 SI SVI"~7,
                                 scenario == "8 EPOCH CCI SI SVI"~8,
                                 scenario == "9 EPOCH CCI SI SVI SSB"~9),
                       levels=c(1:9),
                       labels = c("EPOCH", "CCI", "SI", "SVI", "SSB", "EPOCH+CCI",
                                  "SI+SVI",  "EPOCH+CCI+SI+SVI", "EPOCH+CCI+SI+SVI+SSB"))) %>%
left_join(., det_bmi_df_wide %>% select(-run),
          by=c("scenario","bmi.output","age.groups.output","gender.output"))

lsa_int_si_df<-lsa_int_si_df %>%
  mutate(scenario=factor(case_when(scenario == "1 EPOCH"~1,
                                 scenario == "2 CCI"~2,
                                 scenario == "3 SI"~3,
                                 scenario == "4 SVI"~4,
                                 scenario == "5 SSB"~5,
                                 scenario == "6 EPOCH CCI"~6,
                                 scenario == "7 SI SVI"~7,
                                 scenario == "8 EPOCH CCI SI SVI"~8,
                                 scenario == "9 EPOCH CCI SI SVI SSB"~9),
                       levels=c(1:9),
                       labels = c("EPOCH", "CCI", "SI", "SVI", "SSB", "EPOCH+CCI",
                                  "SI+SVI",  "EPOCH+CCI+SI+SVI", "EPOCH+CCI+SI+SVI+SSB"))) %>%
left_join(., det_bmi_df_wide %>% select(-run),
          by=c("scenario","bmi.output","age.groups.output","gender.output"))

lsa_int_svi_df<-lsa_int_svi_df %>%
  mutate(scenario=factor(case_when(scenario == "1 EPOCH"~1,
                                 scenario == "2 CCI"~2,
                                 scenario == "3 SI"~3,
                                 scenario == "4 SVI"~4,
                                 scenario == "5 SSB"~5,
                                 scenario == "6 EPOCH CCI"~6,
                                 scenario == "7 SI SVI"~7,
                                 scenario == "8 EPOCH CCI SI SVI"~8,
                                 scenario == "9 EPOCH CCI SI SVI SSB"~9),
                       levels=c(1:9),
                       labels = c("EPOCH", "CCI", "SI", "SVI", "SSB", "EPOCH+CCI",
                                  "SI+SVI",  "EPOCH+CCI+SI+SVI", "EPOCH+CCI+SI+SVI+SSB"))) %>%
left_join(., det_bmi_df_wide %>% select(-run),
          by=c("scenario","bmi.output","age.groups.output","gender.output"))

lsa_int_ssb_df<-lsa_int_ssb_df %>%
  mutate(scenario=factor(case_when(scenario == "1 EPOCH"~1,
                                 scenario == "2 CCI"~2,
                                 scenario == "3 SI"~3,
                                 scenario == "4 SVI"~4,
                                 scenario == "5 SSB"~5,
                                 scenario == "6 EPOCH CCI"~6,
                                 scenario == "7 SI SVI"~7,
                                 scenario == "8 EPOCH CCI SI SVI"~8,
                                 scenario == "9 EPOCH CCI SI SVI SSB"~9),
                       levels=c(1:9),
                       labels = c("EPOCH", "CCI", "SI", "SVI", "SSB", "EPOCH+CCI",
                                  "SI+SVI",  "EPOCH+CCI+SI+SVI", "EPOCH+CCI+SI+SVI+SSB"))) %>%
left_join(., det_bmi_df_wide %>% select(-run),
          by=c("scenario","bmi.output","age.groups.output","gender.output"))

```


# EPOCH

## RCT Effects
```{r RCT Effects, echo=F, message=F, error=F, warning=F, fig.height=1*3*2.7, fig.width=1*2*2.7}
derivative_lsa_epoch_int %>% 
  filter(focus=="Effect BF OR") %>% 
  # filter(gender.output=='Male') %>%
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(col=vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Effect BF OR", subtitle = "Per 0.01 units")+
  
  derivative_lsa_epoch_int %>% 
  filter(focus=="Effect TV OR") %>% 
  # filter(gender.output=='Male') %>%
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(col=vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Effect TV OR", subtitle = "Per 0.01 units")+
  
  derivative_lsa_epoch_int %>% 
  filter(focus=="\"Effect Non-core OR\"") %>% 
  # filter(gender.output=='Male') %>%
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(col=vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Effect Non-core OR", subtitle = "Per 0.01 units")+
  
  plot_layout(ncol = 1, nrow=3, guides = "collect")&theme(legend.position = "bottom")
  
  
  
  

```

```{r, fig.height=1*3*2.2, fig.width=1.6*3*2.2}
# lsa_int_epoch_df %>% 
#   filter(year==2057) %>% 
#   filter(focus=="Effect BF OR") %>% 
#   filter(age.groups.output=='Age 2') %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(age.groups.output,bmi.output), scale="free")+
#   theme_bw()+theme(legend.position = "bottom",
#              panel.spacing.y=unit(4, "mm"))+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Effect BF OR")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)+
#   
#   lsa_int_epoch_df %>% 
#   filter(year==2057) %>% 
#   filter(focus=="Effect TV OR") %>% 
#   filter(age.groups.output=='Age 2') %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(age.groups.output,bmi.output), scale="free")+
#   theme_bw()+theme(legend.position = "bottom",
#              panel.spacing.y=unit(4, "mm"))+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Effect TV OR")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)+
#   
#   lsa_int_epoch_df %>% 
#   filter(year==2057) %>% 
#   filter(focus=="\"Effect Non-core OR\"") %>% 
#   filter(age.groups.output=='Age 2') %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(age.groups.output,bmi.output), scale="free")+
#   theme_bw()+theme(legend.position = "bottom",
#              panel.spacing.y=unit(4, "mm"))+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Effect Non-core OR")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)+
#   
#   plot_layout(ncol=3, nrow=1, guides = "collect")&theme(legend.position = "bottom")

```



# Scale up
```{r Scale up der, echo=F, message=F, error=F, warning=F, fig.height=1*1*4, fig.width=1.6*1*4}
derivative_lsa_epoch_int %>% 
  filter(focus=="EPOCH Scale up factor") %>% 
  # filter(gender.output=='Male') %>%
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(col=vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("EPOCH Scale up factor", subtitle = "Per 0.01 units")
```

```{r Scale up, echo=F, message=F, error=F, warning=F, fig.height=1*2*3, fig.width=1*1*3}
# lsa_int_epoch_df %>% 
#   filter(year==2057) %>% 
#   filter(focus=="EPOCH Scale up factor") %>% 
#   filter(age.groups.output=='Age 2') %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(age.groups.output,bmi.output), scale="free")+
#   theme_bw()+theme(legend.position = "bottom",
#              panel.spacing.y=unit(4, "mm"))+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Effect BF OR")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)
```

```{r RCT effects, echo=F, message=F, error=F, warning=F, fig.height=1*1*4, fig.width=1.6*1*4}
# lsa_int_epoch_df %>% 
#   filter(year==2057) %>% 
#   filter(focus=="Effect BF OR") %>% 
#   filter(age.groups.output=='Age 2') %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(age.groups.output,bmi.output), scale="free")+
#   theme_bw()+theme(legend.position = "bottom",
#              panel.spacing.y=unit(4, "mm"))+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Effect BF OR")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)+
#   
#   lsa_int_epoch_df %>% 
#   filter(year==2057) %>% 
#   filter(focus=="Effect TV OR") %>% 
#   filter(age.groups.output=='Age 2') %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(age.groups.output,bmi.output), scale="free")+
#   theme_bw()+theme(legend.position = "bottom",
#              panel.spacing.y=unit(4, "mm"))+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Effect TV OR")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)+
#   
#   lsa_int_epoch_df %>% 
#   filter(year==2057) %>% 
#   filter(focus=="\"Effect Non-core OR\"") %>% 
#   filter(age.groups.output=='Age 2') %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(age.groups.output,bmi.output), scale="free")+
#   theme_bw()+theme(legend.position = "bottom",
#              panel.spacing.y=unit(4, "mm"))+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Effect Non-core OR")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)+
#   
#   plot_layout(ncol=3, nrow=1, guides = "collect")&theme(legend.position = "bottom")
```

# Percentage of infants exposed	
```{r Percentage of infants exposed der, echo=F, message=F, error=F, warning=F, fig.height=1*1*4, fig.width=1.6*1*4}
derivative_lsa_epoch_int %>% 
  filter(focus=="Percentage of infants exposed") %>% 
  # filter(gender.output=='Male') %>%
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(col=vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Percentage of infants exposed", subtitle = "Per 0.01 units")
```


```{r Percentage of infants exposed, echo=F, message=F, error=F, warning=F, fig.height=1*2*3, fig.width=1*1*3}
# lsa_int_epoch_df %>% 
#   filter(year==2057) %>% 
#     filter(focus=="Percentage of infants exposed") %>% 
#   filter(age.groups.output=='Age 2') %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(age.groups.output,bmi.output), scale="free")+
#   theme_bw()+theme(legend.position = "bottom",
#              panel.spacing.y=unit(4, "mm"))+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Percentage of infants exposed")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)
```

## Relapse Rate
```{r Relapse Rate EPOCH der, echo=F, message=F, error=F, warning=F, fig.height=1*1*4, fig.width=1.6*1*4}
derivative_lsa_epoch_int %>% 
  filter(focus=="Relapse Rate") %>% 
  # filter(gender.output=='Male') %>%
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(col=vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Relapse Rate", subtitle = "Per 0.01 units")
```


```{r Relapse Rate1, echo=F, message=F, error=F, warning=F, fig.height=1*2*3, fig.width=1*1*3}
# lsa_int_epoch_df %>% 
#   filter(year==2057) %>% 
#   filter(focus=="Relapse Rate") %>% 
#   # select(input.value)
#   filter(age.groups.output=='Age 35 39') %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(age.groups.output,bmi.output), scale="free")+
#   theme_bw()+theme(legend.position = "bottom",
#              panel.spacing.y=unit(4, "mm"))+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Relapse Rate")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)
```
## Relapse Rate EPOCH
```{r Relapse Rate EPOCH EPOCH der, echo=F, message=F, error=F, warning=F, fig.height=1*1*4, fig.width=1.6*1*4}
derivative_lsa_epoch_int %>% 
  filter(focus=="Relapse Rate EPOCH") %>% 
  # filter(gender.output=='Male') %>%
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(col=vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Relapse Rate", subtitle = "Per 0.01 units")
```

```{r Relapse Rate EPOCH, echo=F, message=F, error=F, warning=F, fig.height=1*2*3, fig.width=1*1*3}
# lsa_int_epoch_df %>% 
#   filter(year==2057) %>% 
#   filter(focus=="Relapse Rate") %>% 
#   # select(input.value)
#   filter(age.groups.output=='Age 2') %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(age.groups.output,bmi.output), scale="free")+
#   theme_bw()+theme(legend.position = "bottom",
#              panel.spacing.y=unit(4, "mm"))+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Relapse Rate")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)
```



# CCI

## CCI Scale up factor
```{r Relapse Rate CCI der, echo=F, message=F, error=F, warning=F, fig.height=1*1*4, fig.width=1.6*1*4}
derivative_lsa_cci_int %>% 
  filter(focus=="CCI Scale up factor") %>% 
  # filter(gender.output=='Male') %>%
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(col=vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("CCI Scale up factor", subtitle = "Per 0.01 units")
```

```{r Relapse Rate CCI, echo=F, message=F, error=F, warning=F, fig.height=1*3*2, fig.width=1*7*1.5}
# lsa_int_cci_df %>% 
#   filter(year==2057) %>% 
#   filter(focus=="CCI Scale up factor") %>% 
#   # select(input.value)
#   filter(as.numeric(age.groups.output)<8) %>%
#   # filter(as.numeric(age.groups.output)<=1) %>%
#   # select(input.value,int.value)
#   # mutate(diff=)
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(bmi.output), cols = vars(age.groups.output), scale="free")+
#   theme_bw()+theme(legend.position = "bottom",
#              panel.spacing.y=unit(4, "mm"))+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("CCI Scale up factor")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)
```

## Childcare settings intervention Change in Diet coefficients
```{r Childcare settings intervention Change in Diet der, echo=F, message=F, error=F, warning=F, fig.height=1*2*2, fig.width=1*5*2}
derivative_lsa_cci_int %>%
  filter(grepl("Childcare settings intervention Change in Diet coefficients", focus)) %>% 
  separate(focus, into=c("first","food.groups"),sep="\\[", remove = F) %>% 
  mutate(food.groups=factor(case_when(food.groups=="Discretionary_foods]"~1,
                                       food.groups=="Fruit]"~2,
                                       food.groups=="NonAlcoholic_beverage]"~3,
                                       food.groups=="Sugar_Sweetened beverage]"~4,
                                       food.groups=="Vegetables]"~5),
                             levels=c(1,2,3,4,5),
                             labels=c("Discretionary foods","Fruit",
                                     "Other beverage","Sugar Sweetened beverage", "Vegetables"))) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(rows =vars(gender.output), cols=vars(food.groups), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Childcare settings intervention Change in Diet", subtitle = "RCT IRR Per 0.01 units")
```

```{r Childcare settings intervention Change in Diet, echo=F, message=F, error=F, warning=F, fig.height=1*15*2, fig.width=1*3*2}
# lsa_int_cci_df %>% 
#   filter(year==2057) %>% 
#    filter(grepl("Childcare settings intervention Change in Diet coefficients", focus)) %>% 
#   separate(focus, into=c("first","food.groups"),sep="\\[", remove = F) %>% 
#   mutate(food.groups=factor(case_when(food.groups=="Discretionary_foods]"~1,
#                                        food.groups=="Fruit]"~2,
#                                        food.groups=="NonAlcoholic_beverage]"~3,
#                                        food.groups=="Sugar_Sweetened beverage]"~4,
#                                        food.groups=="Vegetables]"~5),
#                              levels=c(1,2,3,4,5),
#                              labels=c("Discretionary foods","Fruit",
#                                      "Other beverage","Sugar Sweetened beverage", "Vegetables"))) %>% 
#   filter(food.groups=="Discretionary foods") %>% 
#   filter(as.numeric(age.groups.output)<4) %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(bmi.output), cols = vars(food.groups,age.groups.output,), scale="free")+
#   theme_bw()+theme(legend.position = "bottom")+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Discretionary foods")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)+
#   
#   lsa_int_cci_df %>% 
#   filter(year==2057) %>% 
#    filter(grepl("Childcare settings intervention Change in Diet coefficients", focus)) %>% 
#   separate(focus, into=c("first","food.groups"),sep="\\[", remove = F) %>% 
#   mutate(food.groups=factor(case_when(food.groups=="Discretionary_foods]"~1,
#                                        food.groups=="Fruit]"~2,
#                                        food.groups=="NonAlcoholic_beverage]"~3,
#                                        food.groups=="Sugar_Sweetened beverage]"~4,
#                                        food.groups=="Vegetables]"~5),
#                              levels=c(1,2,3,4,5),
#                              labels=c("Discretionary foods","Fruit",
#                                      "Other beverage","Sugar Sweetened beverage", "Vegetables"))) %>% 
#   filter(food.groups=="Fruit") %>% 
#   filter(as.numeric(age.groups.output)<4) %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(bmi.output), cols = vars(food.groups,age.groups.output,), scale="free")+
#   theme_bw()+theme(legend.position = "bottom")+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Fruit")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)+
#   
#     lsa_int_cci_df %>% 
#   filter(year==2057) %>% 
#    filter(grepl("Childcare settings intervention Change in Diet coefficients", focus)) %>% 
#   separate(focus, into=c("first","food.groups"),sep="\\[", remove = F) %>% 
#   mutate(food.groups=factor(case_when(food.groups=="Discretionary_foods]"~1,
#                                        food.groups=="Fruit]"~2,
#                                        food.groups=="NonAlcoholic_beverage]"~3,
#                                        food.groups=="Sugar_Sweetened beverage]"~4,
#                                        food.groups=="Vegetables]"~5),
#                              levels=c(1,2,3,4,5),
#                              labels=c("Discretionary foods","Fruit",
#                                      "Other beverage","Sugar Sweetened beverage", "Vegetables"))) %>% 
#   filter(food.groups=="Other beverage") %>% 
#   filter(as.numeric(age.groups.output)<4) %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(bmi.output), cols = vars(food.groups,age.groups.output,), scale="free")+
#   theme_bw()+theme(legend.position = "bottom")+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Other beverage")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)+
#   
#       lsa_int_cci_df %>% 
#   filter(year==2057) %>% 
#    filter(grepl("Childcare settings intervention Change in Diet coefficients", focus)) %>% 
#   separate(focus, into=c("first","food.groups"),sep="\\[", remove = F) %>% 
#   mutate(food.groups=factor(case_when(food.groups=="Discretionary_foods]"~1,
#                                        food.groups=="Fruit]"~2,
#                                        food.groups=="NonAlcoholic_beverage]"~3,
#                                        food.groups=="Sugar_Sweetened beverage]"~4,
#                                        food.groups=="Vegetables]"~5),
#                              levels=c(1,2,3,4,5),
#                              labels=c("Discretionary foods","Fruit",
#                                      "Other beverage","Sugar Sweetened beverage", "Vegetables"))) %>% 
#   filter(food.groups=="Sugar Sweetened beverage") %>% 
#   filter(as.numeric(age.groups.output)<4) %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(bmi.output), cols = vars(food.groups,age.groups.output,), scale="free")+
#   theme_bw()+theme(legend.position = "bottom")+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Sugar Sweetened beverage")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)+
#   
#         lsa_int_cci_df %>% 
#   filter(year==2057) %>% 
#    filter(grepl("Childcare settings intervention Change in Diet coefficients", focus)) %>% 
#   separate(focus, into=c("first","food.groups"),sep="\\[", remove = F) %>% 
#   mutate(food.groups=factor(case_when(food.groups=="Discretionary_foods]"~1,
#                                        food.groups=="Fruit]"~2,
#                                        food.groups=="NonAlcoholic_beverage]"~3,
#                                        food.groups=="Sugar_Sweetened beverage]"~4,
#                                        food.groups=="Vegetables]"~5),
#                              levels=c(1,2,3,4,5),
#                              labels=c("Discretionary foods","Fruit",
#                                      "Other beverage","Sugar Sweetened beverage", "Vegetables"))) %>% 
#   filter(food.groups=="Vegetables") %>% 
#   filter(as.numeric(age.groups.output)<4) %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(bmi.output), cols = vars(food.groups,age.groups.output,), scale="free")+
#   theme_bw()+theme(legend.position = "bottom")+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Vegetables")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)+
#   
#   plot_layout(ncol=1, nrow = 5)+theme(legend.position = "bottom")
```

## Childcare settings intervention Change in PA coefficients
```{r Childcare settings intervention Change in PA coefficients der, echo=F, message=F, error=F, warning=F, fig.height=1*3*2, fig.width=1*7*1.5}
derivative_lsa_cci_int %>%
  filter(grepl("Childcare settings intervention Change in PA coefficients", focus)) %>% 
  separate(focus, into=c("first","pa.groups"),sep="\\[", remove = F) %>% 
  mutate(pa.groups=factor(case_when(pa.groups=="Light]"~1,
                                       pa.groups=="Screen]"~2),
                             levels=c(1,2),
                             labels=c("Light physical activity","Screen time"))) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(rows =vars(gender.output), cols=vars(pa.groups), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Childcare settings intervention Change in PA", subtitle = "RCT IRR Per 0.01 units")
```

```{r Childcare settings intervention Change in Diet1, echo=F, message=F, error=F, warning=F, fig.height=1*6*2, fig.width=1*3*2}
# lsa_int_cci_df %>% 
#   filter(year==2057) %>% 
#   filter(grepl("Childcare settings intervention Change in PA coefficients", focus)) %>% 
#   separate(focus, into=c("first","pa.groups"),sep="\\[", remove = F) %>% 
#   mutate(pa.groups=factor(case_when(pa.groups=="Light]"~1,
#                                        pa.groups=="Screen]"~2),
#                              levels=c(1,2),
#                              labels=c("Light physical activity","Screen time"))) %>% 
#   filter(pa.groups=="Light physical activity") %>% 
#   filter(as.numeric(age.groups.output)<4) %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(bmi.output), cols = vars(pa.groups,age.groups.output,), scale="free")+
#   theme_bw()+theme(legend.position = "bottom")+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Light physical activity")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)+
#   
#   lsa_int_cci_df %>% 
#   filter(year==2057) %>% 
#   filter(grepl("Childcare settings intervention Change in PA coefficients", focus)) %>% 
#   separate(focus, into=c("first","pa.groups"),sep="\\[", remove = F) %>% 
#   mutate(pa.groups=factor(case_when(pa.groups=="Light]"~1,
#                                        pa.groups=="Screen]"~2),
#                              levels=c(1,2),
#                              labels=c("Light physical activity","Screen time"))) %>% 
#   filter(pa.groups=="Screen time") %>% 
#   filter(as.numeric(age.groups.output)<4) %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(bmi.output), cols = vars(pa.groups,age.groups.output,), scale="free")+
#   theme_bw()+theme(legend.position = "bottom")+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Screen time")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)+
#   
#   plot_layout(ncol=1, nrow = 2)+theme(legend.position = "bottom")
```

## Percentage of childcare centers participating in intervention
```{r Percentage of childcare centers participating in intervention der, echo=F, message=F, error=F, warning=F, fig.height=1*2*2.8,fig.width=1.6*1*2.8}
derivative_lsa_cci_int %>%
  filter(grepl("Percentage of childcare centers participating in intervention", focus)) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(rows =vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Percentage of childcare centers participating in intervention", subtitle = "Per %")
```

```{r Percentage of childcare centers participating in intervention, echo=F, message=F, error=F, warning=F}
# lsa_int_cci_df %>% 
#   filter(year==2057) %>% 
#   filter(grepl("Percentage of childcare centers participating in intervention", focus)) %>% 
#   filter(as.numeric(age.groups.output)<=3) %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(bmi.output), cols = vars(age.groups.output), scale="free")+
#   theme_bw()+theme(legend.position = "bottom")+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Percentage of childcare centers participating in intervention")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)
```


## Definition in food groups
```{r Proportion of Cordial in SSB der, echo=F, message=F, error=F, warning=F, fig.height=1*2*3, fig.width=1.6*2*3}
derivative_lsa_cci_int %>%
  filter(grepl("Proportion of Cordial in SSB", focus)) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(rows =vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Proportion of Cordial in SSB", subtitle = "Per 0.01")+
  
  derivative_lsa_cci_int %>%
  filter(grepl("Proportion of Packed snacks in Discretionary foods", focus)) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(rows =vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  # scale_y_continuous(labels = scales::percent)+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Proportion of Packed snacks in Discretionary foods", subtitle = "Per 0.01")+
  
  plot_layout(ncol=2, nrow=1, guides = "collect")&theme(legend.position = "bottom")
```


```{r Proportion of Cordial in SSB,echo=F, message=F, error=F, warning=F, fig.height=1*6*2, fig.width=1.6*3*2}
# lsa_int_cci_df %>% 
#   filter(year==2057) %>% 
#   filter(grepl("Proportion of Cordial in SSB", focus)) %>% 
#   filter(as.numeric(age.groups.output)<=3) %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(bmi.output), cols = vars(age.groups.output), scale="free")+
#   theme_bw()+theme(legend.position = "bottom")+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Proportion of Cordial in SSB")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)+
# 
# lsa_int_cci_df %>% 
#   filter(year==2057) %>% 
#   filter(grepl("Proportion of Packed snacks in Discretionary foods", focus)) %>% 
#   filter(as.numeric(age.groups.output)<=3) %>%
#   ggplot()+
#   geom_point(aes(x=input.value, y=int.value, color=gender.output), size=1)+
#   geom_line(aes(x=input.value, y=int.value, color=gender.output))+
#   geom_hline(aes(yintercept=det.int.value), linetype="dashed")+
#   facet_grid( rows = vars(bmi.output), cols = vars(age.groups.output), scale="free")+
#   theme_bw()+theme(legend.position = "bottom")+
#   guides(colour = guide_legend("BMI"))+
#   ggtitle("Proportion of Packed snacks in Discretionary foods")+ylab("Prevalence")+
#   xlab("Input assumption")+
#   scale_y_continuous(labels = scales::percent)+
#   
#     plot_layout(ncol=1, nrow=2, guides = "collect")&theme(legend.position = "bottom")
```


# SI

## Relapse Rate
```{r Relapse Rate SI der, echo=F, message=F, error=F, warning=F, fig.height=1*2*3, fig.width=1.6*2*3}
derivative_lsa_si_int %>%
  filter(grepl("Relapse Rate", focus)) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(rows =vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Relapse Rate", subtitle = "Per %")

```



## SI Percentage of Schools participating in intervention
```{r SI Percentage of Schools participating in intervention der, echo=F, message=F, error=F, warning=F, fig.height=1*2*3, fig.width=1.6*2*3}
derivative_lsa_si_int %>%
  filter(grepl("SI Percentage of Schools participating in intervention", focus)) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(rows =vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("SI Percentage of Schools participating in intervention", subtitle = "Per %")

```

## SI percentage of total diet consumed at school
```{r SI percentage of total diet consumed at school der, echo=F, message=F, error=F, warning=F, fig.height=1*2*3, fig.width=1.6*2*3}
derivative_lsa_si_int %>%
  filter(grepl("SI percentage of total diet consumed at school", focus)) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(rows =vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("SI percentage of total diet consumed at school", subtitle = "Per %")

```

## SI Scale up factor
```{r SI Scale up factor der , echo=F, message=F, error=F, warning=F, fig.height=1*2*3, fig.width=1.6*2*3}
derivative_lsa_si_int %>%
  filter(grepl("SI Scale up factor", focus)) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(rows =vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("SI Scale up factor", subtitle = "Per %")

```

## SI % change in PA
```{r SI change in PA der, echo=F, message=F, error=F, warning=F, fig.height=1*2*3, fig.width=1.6*2*3}
derivative_lsa_si_int %>%
  filter(grepl("SI % change in PA", focus)) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  # geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output), se=F, linewidth=0.5)+
  facet_grid(rows =vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("SI % change in PA", subtitle = "Per %")

```

## SI % Reduction In student Purchases
```{r SI Reduction In student Purchases der, echo=F, message=F, error=F, warning=F, fig.height=1*11*2, fig.width=1.6*2*2}
derivative_lsa_si_int %>% 
  filter(grepl("SI % Reduction In student Purchases", focus)) %>% 
  separate(focus, into=c("first","food.groups"),sep="\\[", remove = F) %>% 
  mutate(food.groups=factor(case_when(food.groups=="Dairy]"~1,
                                      food.groups=="Discretionary_foods]"~2,
                                      food.groups=="Fats]"~3,
                                      food.groups=="Fruit]"~4,
                                      food.groups=="Grains]"~5,
                                      food.groups=="Meat]"~6,
                                      food.groups=="NonAlcoholic_beverage]"~7,
                                      food.groups=="Other]"~8,
                                      food.groups=="Sugar_Sweetened beverage]"~9,
                                      food.groups=="Vegetables]"~10,
                                      food.groups=="Water]"~11),
                             levels=c(seq(1:11)),
                             labels=c("Dairy","Discretionary foods","Fats","Fruit","Grains","Meat",
                                     "Other beverage","Other","Sugar Sweetened beverage", "Vegetables", "Water"))) %>% 
  # filter(food.groups=="Discretionary foods") %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output))+
  facet_grid(cols =vars(gender.output), rows=vars(food.groups), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("SI % Reduction In student Purchases", subtitle = "Per %")
  
```
          

## SI Percentage of children attending School                                    
```{r SI Percentage of children attending School der, echo=F, message=F, error=F, warning=F, fig.height=1*5*2, fig.width=1.6*2*2}
derivative_lsa_si_int %>% 
  filter(grepl("SI Percentage of children attending School", focus)) %>% 
  separate(focus, into=c("first","age.groups.intput"),sep="\\[", remove = F) %>% 
  mutate( age.groups.input=factor(case_when(grepl("Age_2,",age.groups.intput)~1,
                                              grepl("Age_3_5",age.groups.intput)~2,
                                              grepl("Age_6_8",age.groups.intput)~3,
                                              grepl("Age_9_11" ,age.groups.intput)~4,
                                              grepl("Age_12_14",age.groups.intput)~5,
                                              grepl("Age_15_17",age.groups.intput)~6,
                                              grepl("Age_18_19",age.groups.intput)~7,
                                              grepl("Age_20_24",age.groups.intput)~8,
                                              grepl("Age_25_29",age.groups.intput)~9,
                                              grepl("Age_30_34",age.groups.intput)~10,
                                              grepl("Age_35_39",age.groups.intput)~11,
                                              grepl("Age_40_44",age.groups.intput)~12,
                                              grepl("Age_45_49",age.groups.intput)~13),
                                    levels=c(seq(1:13)), 
                                    labels=c("Age 2","Age 3 5","Age 6 8","Age 9 11","Age 12 14","Age 15 17",
                                             "Age 18 19","Age 20 24" ,"Age 25 29","Age 30 34","Age 35 39",
                                             "Age 40 44","Age 45 49"))) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output))+
  facet_grid(cols =vars(gender.output), rows=vars(age.groups.input), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("SI Percentage of children attending School", subtitle = "Per %")
  
```

# SVI
## % of population that Registers for vouchers
```{r percentage of population that Registers for vouchers der,echo=F, message=F, error=F, warning=F, fig.height=1*5*2, fig.width=1.6*2*2}
derivative_lsa_svi_int %>% 
  filter(grepl("% of population that Registers for vouchers", focus)) %>% 
  separate(focus, into=c("first","age.groups.intput"),sep="\\[", remove = F) %>% 
  mutate( age.groups.input=factor(case_when(grepl("Age_2,",age.groups.intput)~1,
                                              grepl("Age_3_5",age.groups.intput)~2,
                                              grepl("Age_6_8",age.groups.intput)~3,
                                              grepl("Age_9_11" ,age.groups.intput)~4,
                                              grepl("Age_12_14",age.groups.intput)~5,
                                              grepl("Age_15_17",age.groups.intput)~6,
                                              grepl("Age_18_19",age.groups.intput)~7,
                                              grepl("Age_20_24",age.groups.intput)~8,
                                              grepl("Age_25_29",age.groups.intput)~9,
                                              grepl("Age_30_34",age.groups.intput)~10,
                                              grepl("Age_35_39",age.groups.intput)~11,
                                              grepl("Age_40_44",age.groups.intput)~12,
                                              grepl("Age_45_49",age.groups.intput)~13),
                                    levels=c(seq(1:13)), 
                                    labels=c("Age 2","Age 3 5","Age 6 8","Age 9 11","Age 12 14","Age 15 17",
                                             "Age 18 19","Age 20 24" ,"Age 25 29","Age 30 34","Age 35 39",
                                             "Age 40 44","Age 45 49"))) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output))+
  facet_grid(cols =vars(gender.output), rows=vars(age.groups.input), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("% of population that Registers for vouchers", subtitle = "Per %")
```

## Average Number of Hours of organised sports or activities Weekly
```{r Average Number of Hours of organised sports or activities Weekly der ,echo=F, message=F, error=F, warning=F, fig.height=1*5*1.5, fig.width=1.6*6*1.5}
derivative_lsa_svi_int %>% 
  filter(grepl("Average Number of Hours of organised sports or activities Weekly", focus)) %>% 
  separate(focus, into=c("first","age.groups.input"),sep="\\[", remove = F) %>% 
  mutate(bmi.input=factor(case_when(grepl("Underweight & Healthy weight", age.groups.input)~1,
                                    grepl("Overweight", age.groups.input)~2,
                                    grepl("Obese", age.groups.input)~3),
                          levels=c(1,2,3),labels=c("Underweight & Healthy weight", "Overweight", "With obesity"))) %>% 
  mutate(age.groups.input=factor(case_when(grepl("Age_2,",age.groups.input)~1,
                                              grepl("Age_3_5",age.groups.input)~2,
                                              grepl("Age_6_8",age.groups.input)~3,
                                              grepl("Age_9_11" ,age.groups.input)~4,
                                              grepl("Age_12_14",age.groups.input)~5,
                                              grepl("Age_15_17",age.groups.input)~6,
                                              grepl("Age_18_19",age.groups.input)~7,
                                              grepl("Age_20_24",age.groups.input)~8,
                                              grepl("Age_25_29",age.groups.input)~9,
                                              grepl("Age_30_34",age.groups.input)~10,
                                              grepl("Age_35_39",age.groups.input)~11,
                                              grepl("Age_40_44",age.groups.input)~12,
                                              grepl("Age_45_49",age.groups.input)~13),
                                    levels=c(seq(1:13)), 
                                    labels=c("Age 2","Age 3 5","Age 6 8","Age 9 11","Age 12 14","Age 15 17",
                                             "Age 18 19","Age 20 24" ,"Age 25 29","Age 30 34","Age 35 39",
                                             "Age 40 44","Age 45 49"))) %>% 
  # select(age.groups.output,mean.ee.alt )
  # filter(bmi.input=="With obesity") %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output))+
  facet_grid(cols =vars(gender.output,bmi.input), rows=vars(age.groups.input), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Average Number of Hours of organised sports or activities Weekly")
```

## Average proportion attributed to vouchers
```{r Average proportion attributed to vouchers der,echo=F, message=F, error=F, warning=F, fig.height=1*1*3, fig.width=1*2*3}
derivative_lsa_svi_int %>% 
  filter(grepl("Average proportion attributed to vouchers", focus)) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  facet_grid(cols =vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Average proportion attributed to vouchers", subtitle = "Per 0.01")
```


## Average MET for sports Inputs   
```{r Females Average MET Calculated Inputs der,echo=F, message=F, error=F, warning=F, fig.height=1*2*3, fig.width=1*2*3}
derivative_lsa_svi_int %>% 
  filter(grepl("Females Average MET Calculated Inputs", focus)) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output))+
  facet_grid(cols =vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Females Average MET Calculated Inputs")+
  
  derivative_lsa_svi_int %>% 
  filter(grepl("Males Average MET Calculated Inputs", focus)) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output))+
  facet_grid(cols =vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Male Average MET Calculated Inputs")+
  
  plot_layout(ncol=1, nrow = 2, guides = "collect")&theme(legend.position ="bottom")
```

## Relapse Rate
```{r Relapse Rate SVI der,echo=F, message=F, error=F, warning=F, fig.height=1.2*1*3, fig.width=1*2*3}
derivative_lsa_svi_int %>% 
  filter(grepl("Relapse Rate", focus)) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  facet_grid(cols =vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Relapse Rate", subtitle = "per %")
```


## SVI Scale up factor
```{r SVI Scale up factor der,echo=F, message=F, error=F, warning=F, fig.height=1.2*1*3, fig.width=1*2*3}
derivative_lsa_svi_int %>% 
  filter(grepl("SVI Scale up factor", focus)) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  facet_grid(cols =vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("SVI Scale up factor", subtitle = "per %")
```

# SSB Tax

## PE Cordial
```{r PE Cordial der,echo=F, message=F, error=F, warning=F, fig.height=1*7*2, fig.width=1.5*2*2}
derivative_lsa_ssb_int %>% 
  filter(grepl("PE Cordial", focus)) %>% 
  # select(focus) %>% table()
  separate(focus, into=c("first","drink.groups"),sep="\\[", remove = F) %>% 
  mutate(drink.groups=factor(case_when(drink.groups=="Regular Soft_Drinks]"~1,
                                      drink.groups=="Fruit Drink]"~2,
                                      drink.groups=="Fruit Juice]"~3,
                                      drink.groups=="Low Fat Milk]"~4,
                                      drink.groups=="Cordial]"~5,
                                      drink.groups=="Tea]"~6,
                                      drink.groups=="Water]"~7,
                                      drink.groups=="Diet Soft Drinks]"~8,
                                      drink.groups=="Coffee]"~9),
                             levels=c(seq(1:9)),
                             labels=c("Regular Soft Drinks","Fruit Drink","Fruit Juice",
                                      "Low Fat Milk","Cordial","Tea","Water", "Diet Soft Drinks","Coffee"))) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  facet_grid(cols =vars(gender.output), rows = vars(drink.groups), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Price elasticitiy for cordial", subtitle = "per 0.01")
```


## PE Fruit Drink
```{r PE Fruit Drink der,echo=F, message=F, error=F, warning=F, fig.height=1*7*2, fig.width=1.5*2*2}
derivative_lsa_ssb_int %>% 
  filter(grepl("PE Fruit Drink", focus)) %>% 
  # select(focus) %>% table()
  separate(focus, into=c("first","drink.groups"),sep="\\[", remove = F) %>% 
  mutate(drink.groups=factor(case_when(drink.groups=="Regular Soft_Drinks]"~1,
                                      drink.groups=="Fruit Drink]"~2,
                                      drink.groups=="Fruit Juice]"~3,
                                      drink.groups=="Low Fat Milk]"~4,
                                      drink.groups=="Cordial]"~5,
                                      drink.groups=="Tea]"~6,
                                      drink.groups=="Water]"~7,
                                      drink.groups=="Diet Soft Drinks]"~8,
                                      drink.groups=="Coffee]"~9),
                             levels=c(seq(1:9)),
                             labels=c("Regular Soft Drinks","Fruit Drink","Fruit Juice",
                                      "Low Fat Milk","Cordial","Tea","Water", "Diet Soft Drinks","Coffee"))) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  facet_grid(cols =vars(gender.output), rows = vars(drink.groups), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Price elasticitiy for fruit drink", subtitle = "per 0.01")
```

## PE Soft drink
```{r PE Soft drink der,echo=F, message=F, error=F, warning=F, fig.height=1*3*2, fig.width=1.5*2*2}
derivative_lsa_ssb_int %>% 
  filter(grepl("PE Soft drink", focus)) %>% 
  # select(focus) %>% table()
  separate(focus, into=c("first","drink.groups"),sep="\\[", remove = F) %>% 
  mutate(drink.groups=factor(case_when(drink.groups=="Regular Soft_Drinks]"~1,
                                      drink.groups=="Fruit Drink]"~2,
                                      drink.groups=="Fruit Juice]"~3,
                                      drink.groups=="Low Fat Milk]"~4,
                                      drink.groups=="Cordial]"~5,
                                      drink.groups=="Tea]"~6,
                                      drink.groups=="Water]"~7,
                                      drink.groups=="Diet Soft Drinks]"~8,
                                      drink.groups=="Coffee]"~9),
                             levels=c(seq(1:9)),
                             labels=c("Regular Soft Drinks","Fruit Drink","Fruit Juice",
                                      "Low Fat Milk","Cordial","Tea","Water", "Diet Soft Drinks","Coffee"))) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  facet_grid(cols =vars(gender.output), rows = vars(drink.groups), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Price elasticitiy for fruit drink", subtitle = "per 0.01")
```

## Relapse Rate
```{r Relapse Rate SSB der,echo=F, message=F, error=F, warning=F, fig.height=1*2*2, fig.width=1.5*2*2}
derivative_lsa_ssb_int %>% 
  filter(grepl("Relapse Rate", focus)) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  facet_grid(cols =vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Relapse Rate", subtitle = "per 0.01")
```

## SSB Scale up factor
```{r SSB Scale up factor der,echo=F, message=F, error=F, warning=F, fig.height=1*2*2, fig.width=1.5*2*2}
derivative_lsa_ssb_int %>% 
  filter(grepl("SSB Scale up factor", focus)) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt/100, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt/100, color=bmi.output))+
  facet_grid(cols =vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("Price elasticitiy for fruit drink", subtitle = "per 0.01")
```

## SSB Tax %
```{r SB Tax percent der,echo=F, message=F, error=F, warning=F, fig.height=1*2*2, fig.width=1.5*2*2}
derivative_lsa_ssb_int %>% 
  filter(grepl("SSB Tax", focus)) %>% 
  ggplot()+
  geom_point(aes(x=age.groups.output, y=mean.ee.alt, color=bmi.output), size=1)+
  geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.alt, color=bmi.output))+
  facet_grid(cols =vars(gender.output), scale="free")+
  scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
                   labels=c("3 5", "18 19", "40 44"))+
  xlab("Age group")+ylab(expression(mu[EE]))+
  theme_bw()+theme(legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1))+
  guides(colour = guide_legend("BMI"))+
  ggtitle("SSB Tax %", subtitle = "per 0.01")
```

### Something